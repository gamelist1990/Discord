#!/usr/bin/env python3
# ç°¡ç•¥åŒ–ã•ã‚ŒãŸDiscordãƒœãƒƒãƒˆ YouTubeé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
import discord
from discord.ext import commands
import aiohttp
import asyncio
import re
from datetime import datetime
from typing import Optional
from DataBase import get_guild_value, update_guild_data

class NotificationSystem(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.checking = False
        self.loop_task = None
    
    @commands.Cog.listener()
    async def on_ready(self):
        """ãƒœãƒƒãƒˆèµ·å‹•æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹"""
        if not self.checking:
            print(f"[{datetime.now().strftime('%H:%M:%S')}] é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹")
            self.start_check_loop()
    
    def start_check_loop(self):
        """ã‚·ãƒ³ãƒ—ãƒ«ãªãƒã‚§ãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹"""
        if self.loop_task is None or self.loop_task.done():
            self.loop_task = self.bot.loop.create_task(self.simple_check_loop())
    
    async def simple_check_loop(self):
        """1åˆ†é–“éš”ã§ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹è»½é‡ãƒ«ãƒ¼ãƒ—"""
        self.checking = True
        while True:
            try:
                await self.check_all_channels()
                await asyncio.sleep(60)  # 1åˆ†å¾…æ©Ÿ
            except Exception as e:
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ãƒ«ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
                await asyncio.sleep(60)
    
    async def check_all_channels(self):
        """å…¨ã‚®ãƒ«ãƒ‰ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ãƒã‚§ãƒƒã‚¯"""
        for guild in self.bot.guilds:
            channels = get_guild_value(guild.id, 'youtube_channels', [])
            for channel_info in channels:
                await self.check_one_channel(guild, channel_info)
    
    async def check_one_channel(self, guild, channel_info):
        """å˜ä¸€ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ©ã‚¤ãƒ–çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯"""
        try:
            channel_id = self.extract_channel_id(channel_info.get('url', ''))
            if not channel_id:
                return
            
            is_live = await self.simple_live_check(channel_id)
            
            # çŠ¶æ…‹å¤‰åŒ–ã‚’ãƒã‚§ãƒƒã‚¯
            was_live = channel_info.get('was_live', False)
            if is_live and not was_live:
                await self.send_live_notification(guild, channel_info)
                channel_info['was_live'] = True
                self.update_channel_state(guild.id, channel_info)
            elif not is_live and was_live:
                channel_info['was_live'] = False
                self.update_channel_state(guild.id, channel_info)
                
        except Exception as e:
            print(f"[{datetime.now().strftime('%H:%M:%S')}] ãƒãƒ£ãƒ³ãƒãƒ«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {e}")
    
    def extract_channel_id(self, url):
        """URLã‹ã‚‰ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’æŠ½å‡ºï¼ˆç°¡ç•¥ç‰ˆï¼‰"""
        patterns = [
            r'channel/([a-zA-Z0-9_-]+)',
            r'c/([a-zA-Z0-9_-]+)',
            r'user/([a-zA-Z0-9_-]+)',
            r'@([a-zA-Z0-9_-]+)'
        ]
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                return match.group(1)
        return None
    
    async def simple_live_check(self, channel_id):
        """è»½é‡ãªãƒ©ã‚¤ãƒ–é…ä¿¡ãƒã‚§ãƒƒã‚¯"""
        try:
            timeout = aiohttp.ClientTimeout(total=10)
            async with aiohttp.ClientSession(timeout=timeout) as session:
                url = f"https://www.youtube.com/feeds/videos.xml?channel_id={channel_id}"
                async with session.get(url) as response:
                    if response.status != 200:
                        return False
                    
                    content = await response.text()
                    # ç°¡å˜ãªãƒ©ã‚¤ãƒ–æ¤œå‡ºï¼šisLive":trueã‚’æ¢ã™
                    return '"isLive":true' in content
        except:
            return False
    
    async def send_live_notification(self, guild, channel_info):
        """ãƒ©ã‚¤ãƒ–é€šçŸ¥ã‚’é€ä¿¡"""
        try:
            notify_channel_id = get_guild_value(guild.id, 'notify_channel')
            if not notify_channel_id:
                return
            
            channel = guild.get_channel(notify_channel_id)
            if not channel:
                return
            
            embed = discord.Embed(
                title="ğŸ”´ ãƒ©ã‚¤ãƒ–é…ä¿¡é–‹å§‹ï¼",
                description=f"**{channel_info.get('name', 'ãƒãƒ£ãƒ³ãƒãƒ«')}** ãŒãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼",
                color=0xff0000,
                timestamp=datetime.now()
            )
            embed.add_field(name="ãƒãƒ£ãƒ³ãƒãƒ«", value=channel_info.get('url', ''), inline=False)
            
            await channel.send(embed=embed)
            print(f"[{datetime.now().strftime('%H:%M:%S')}] é€šçŸ¥é€ä¿¡: {channel_info.get('name', 'Unknown')}")
            
        except Exception as e:
            print(f"[{datetime.now().strftime('%H:%M:%S')}] é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
    
    def update_channel_state(self, guild_id, channel_info):
        """ãƒãƒ£ãƒ³ãƒãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°"""
        channels = get_guild_value(guild_id, 'youtube_channels', [])
        for i, ch in enumerate(channels):
            if ch.get('url') == channel_info.get('url'):
                channels[i] = channel_info
                break
        update_guild_data(guild_id, 'youtube_channels', channels)
    
    # === ã‚³ãƒãƒ³ãƒ‰ ===
    
    @commands.command(name="notify_channel")
    @commands.has_permissions(administrator=True)
    async def set_notify_channel(self, ctx, channel: Optional[discord.TextChannel] = None):
        """é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¨­å®š"""
        target_channel = channel if channel else ctx.channel
        
        update_guild_data(ctx.guild.id, 'notify_channel', target_channel.id)
        await ctx.send(f"âœ… é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ {target_channel.mention} ã«è¨­å®šã—ã¾ã—ãŸ")
    
    @commands.command(name="add_youtube")
    @commands.has_permissions(administrator=True)
    async def add_youtube_channel(self, ctx, url, *, name=None):
        """YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¿½åŠ """
        channel_id = self.extract_channel_id(url)
        if not channel_id:
            await ctx.send("âŒ æœ‰åŠ¹ãªYouTubeãƒãƒ£ãƒ³ãƒãƒ«URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
            return
        
        channels = get_guild_value(ctx.guild.id, 'youtube_channels', [])
        
        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        for ch in channels:
            if ch.get('url') == url:
                await ctx.send("âŒ ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™")
                return
        
        channel_info = {
            'url': url,
            'name': name or f"ãƒãƒ£ãƒ³ãƒãƒ«_{len(channels)+1}",
            'was_live': False
        }
        
        channels.append(channel_info)
        update_guild_data(ctx.guild.id, 'youtube_channels', channels)
        
        await ctx.send(f"âœ… YouTubeãƒãƒ£ãƒ³ãƒãƒ« **{channel_info['name']}** ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
    
    @commands.command(name="remove_youtube")
    @commands.has_permissions(administrator=True)
    async def remove_youtube_channel(self, ctx, *, name_or_url):
        """YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‰Šé™¤"""
        channels = get_guild_value(ctx.guild.id, 'youtube_channels', [])
        
        for i, ch in enumerate(channels):
            if ch.get('name') == name_or_url or ch.get('url') == name_or_url:
                removed_channel = channels.pop(i)
                update_guild_data(ctx.guild.id, 'youtube_channels', channels)
                await ctx.send(f"âœ… YouTubeãƒãƒ£ãƒ³ãƒãƒ« **{removed_channel['name']}** ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
                return
        
        await ctx.send("âŒ æŒ‡å®šã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    @commands.command(name="list_youtube")
    async def list_youtube_channels(self, ctx):
        """ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹YouTubeãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§"""
        channels = get_guild_value(ctx.guild.id, 'youtube_channels', [])
        
        if not channels:
            await ctx.send("ğŸ“ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“")
            return
        
        embed = discord.Embed(title="ğŸ“º ç™»éŒ²ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§", color=0x00ff00)
        
        for ch in channels:
            status = "ğŸ”´ ãƒ©ã‚¤ãƒ–ä¸­" if ch.get('was_live', False) else "âš« ã‚ªãƒ•ãƒ©ã‚¤ãƒ³"
            embed.add_field(
                name=f"{ch.get('name', 'Unknown')} {status}",
                value=ch.get('url', ''),
                inline=False
            )
        
        await ctx.send(embed=embed)
    
    @commands.command(name="check_now")
    @commands.has_permissions(administrator=True)
    async def manual_check(self, ctx):
        """æ‰‹å‹•ã§ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’ãƒã‚§ãƒƒã‚¯"""
        await ctx.send("ğŸ” ãƒã‚§ãƒƒã‚¯ä¸­...")
        await self.check_all_channels()
        await ctx.send("âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†")

async def setup(bot):
    await bot.add_cog(NotificationSystem(bot))